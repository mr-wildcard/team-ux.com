---
import CallToAction from "./@common/CallToAction.astro";

interface Props {
  label: string;
  textToCopy: string;
  toastCopySuccessText: string;
}

const {
  label,
  textToCopy,
  toastCopySuccessText,
  class: cssClasses,
  ...props
} = Astro.props;
---

<CallToAction
  {...props}
  class:list={["copy-text", cssClasses]}
  leftIcon="content_copy"
  data-text-to-copy={textToCopy}
  data-toast-copy-success-text={toastCopySuccessText}
>
  <slot />
</CallToAction>

<script>
  const buttons = document.querySelectorAll("button.copy-text");
  const toast = document.querySelector("#toast");
  const toastContent = toast.querySelector("span");

  function showToast() {
    toast.classList.add("show");
  }

  function hideToast() {
    toast.classList.add("hide");
  }

  function onUserScrolls() {
    toast.classList.add("hide");
  }

  // Hack for Safari not replaying the animation when we click on the button several times.
  // Removing classes after the animation allows the toast to appear again.
  toast.addEventListener("animationend", () => {
    toast.classList.remove("show", "hide");
    window.removeEventListener("scroll", onUserScrolls);
  });

  buttons.forEach((button) => {
    const { textToCopy, toastCopySuccessText } = button.dataset;

    async function onUserClicksOnCopyButton() {
      button.removeEventListener("click", onUserClicksOnCopyButton);

      toast.classList.remove("show", "hide");
      toastContent.textContent = toastCopySuccessText;

      try {
        await navigator.clipboard.writeText(textToCopy);
        await showToast();
      } catch (err) {
        console.error("Failed to copy text:", textToCopy, err);
      } finally {
        button.addEventListener("click", onUserClicksOnCopyButton);
        window.addEventListener("scroll", onUserScrolls);
      }
    }

    button.addEventListener("click", onUserClicksOnCopyButton);
  });

  toast.addEventListener("click", hideToast);
</script>
